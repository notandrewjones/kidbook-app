<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kids Book Creator</title>

  <!-- Google Fonts for Kid-Friendly Templates -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=ABeeZee&family=Baloo+2:wght@400;600;700;800&family=Bubblegum+Sans&family=Caveat:wght@400;600;700&family=Chewy&family=Comic+Neue:wght@400;700&family=Fredoka+One&family=Kalam:wght@400;700&family=Luckiest+Guy&family=Nunito:wght@400;600;700;800&family=Patrick+Hand&family=Poppins:wght@400;500;600;700&family=Quicksand:wght@400;500;600;700&family=Schoolbell&family=Sniglet:wght@400;800&family=Varela+Round&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/css/compositor.css" />
  <link rel="stylesheet" href="/css/auth.css" />
</head>

<body>
  <!-- App Shell -->
  <div class="app-shell">

    <!-- Top Nav -->
    <header class="topbar">
      <div class="topbar-left">
        <a href="/dashboard" id="brand-link" class="brand">
          <div class="brand-mark">KB</div>
          <div class="brand-text">
            <div class="brand-name">Business Name</div>
            <div class="brand-sub">Business Tagline</div>
          </div>
        </a>

        <button id="nav-dashboard" class="btn btn-secondary nav-btn">
          <span>Dashboard</span>
        </button>
      </div>

      <div class="topbar-right">
        <div class="search-wrap">
          <input id="global-search" class="search-input" placeholder="Search projects..." />
          <span class="kbd-hint">⌘K</span>
          <div id="search-dropdown" class="search-dropdown hidden"></div>
        </div>

        <!-- Generation Queue/History Button -->
        <div class="queue-wrap">
          <button id="queue-btn" class="icon-btn" title="Generation Queue & History">
            <span class="icon">⚡</span>
            <span id="queue-badge" class="queue-badge hidden">0</span>
          </button>
          <div id="queue-dropdown" class="queue-dropdown hidden">
            <div class="queue-header">
              <span class="queue-title">Generation Activity</span>
            </div>
            <div id="queue-list" class="queue-list">
              <div class="queue-empty">No recent generations</div>
            </div>
            <div class="queue-footer">
              <button id="show-all-history" class="btn btn-ghost btn-sm">Show All History</button>
            </div>
          </div>
        </div>

        <button id="theme-toggle" class="icon-btn" title="Toggle theme (placeholder)">
          <span class="icon">☾</span>
        </button>

        <!-- Account placeholder -->
        <div class="account">
          <button id="account-btn" class="account-btn">
            <span class="avatar">A</span>
            <span class="account-meta">
              <span class="account-name">Account</span>
              <span class="account-sub">Login / Sign up</span>
            </span>
            <span class="chev">▾</span>
          </button>

          <div id="account-menu" class="account-menu hidden">
            <button class="menu-item" id="login-btn">Log In</button>
            <button class="menu-item hidden" id="profile-btn">My Profile</button>
            <div class="menu-sep"></div>
            <button class="menu-item hidden" id="logout-btn">Log Out</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main id="main" class="main dashboard-mode">
      <!-- Left Panel / Controls -->
      <aside class="panel" id="sidebar-panel">
        <!-- Create new book panel - only used in non-dashboard views -->
        <div class="panel-card" id="create-book-panel">
          <div class="panel-title">Create a new book</div>

          <form id="kid-form" class="form">
            <label class="label">Main Character's Name</label>
            <input id="kid-name" class="input" type="text" placeholder="e.g., Hannah" required />

            <label class="label">Story Topic</label>
            <input id="kid-interests" class="input" type="text" placeholder="e.g., space, puppies, soccer" />

            <button type="submit" class="btn btn-primary">
              <span>Generate Story Ideas</span>
              <span class="btn-suffix">↵</span>
            </button>
          </form>

          <div class="panel-actions">
            <button id="reset-session" class="btn btn-ghost">Start New Story</button>
            <button id="go-dashboard" class="btn btn-secondary">My Stories</button>
          </div>
        </div>

        <div class="panel-card subtle" id="tips-panel">
          <div class="panel-title">Tips</div>
          <ul class="tips">
            <li>If you have a specific vision for your story, include as much detail as your can in your 'topic' submission.</li>
          </ul>
        </div>
      </aside>

      <!-- Workspace -->
      <section class="workspace">
        <div class="workspace-head">
          <div class="workspace-title">
            <h2 id="workspace-title">Workspace</h2>
            <p id="workspace-subtitle">Pick a project or generate story ideas to begin.</p>
          </div>

          <!-- View / Filter Controls -->
          <div class="workspace-controls">
            <div class="segmented">
              <button class="seg-btn active" data-view="grid" id="view-grid">Grid</button>
              <button class="seg-btn" data-view="list" id="view-list">List</button>
            </div>

            <select id="page-filter" class="select">
              <option value="all">All pages</option>
              <option value="missing">Missing</option>
              <option value="ready">Ready</option>
              <option value="errors">Errors</option>
            </select>
          </div>
        </div>

        <!-- Workspace body: phase-controlled layout -->
        <div class="workspace-body">

          <!-- Storyboard-only: character panel column -->
          <aside id="character-panel" class="character-panel" aria-label="Character panel">
            <div id="character-panel-content"></div>
          </aside>

          <!-- Main results mount (used in all phases) -->
          <div id="results" class="results"></div>

        </div>
        
      </section>
    </main>

    <!-- Illustration Preview + Regenerate Modal -->
    <div id="image-modal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-dialog modal-dialog-preview" role="dialog" aria-modal="true">
        <div class="modal-header">
          <div class="modal-header-left">
            <div class="modal-title">Illustration Preview</div>
            <div id="modal-subtitle" class="modal-subtitle">Page</div>
          </div>
          <button id="close-modal" class="icon-btn modal-close-btn" title="Close">✕</button>
        </div>

        <div class="modal-body modal-body-preview">
          <!-- Left side: Main image preview -->
          <div class="preview-main">
            <div class="modal-image-wrap">
              <img id="modal-image" src="" alt="Illustration preview" />
            </div>
          </div>

          <!-- Right side: Controls and history -->
          <div class="preview-controls">
            <!-- Current version indicator -->
            <div class="preview-section">
              <div class="preview-section-label">Current Version</div>
              <div id="current-version-indicator" class="hidden"></div>
            </div>
            
            <!-- Revision history -->
            <div id="revision-history" class="preview-section hidden">
              <div class="preview-section-label">Previous Versions</div>
              <div class="revision-thumbs-container"></div>
            </div>
            
            <!-- Use this version button (shown when viewing a past revision) -->
            <button id="use-version-btn" class="btn btn-secondary btn-full hidden">
              <span>↩ Use This Version</span>
            </button>
            
            <!-- Regeneration controls -->
            <div class="preview-section preview-regen-section">
              <div class="preview-section-label">Regenerate with Notes</div>
              <div class="form-group">
                <textarea id="revision-notes" class="textarea textarea-sm" placeholder="e.g., remove balloons, make it sunset, add more cowbell..."></textarea>
              </div>
              <button id="regen-btn" class="btn btn-primary btn-full">
                <span>Regenerate</span>
                <span class="pill">max 2</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Custom Upload Modal -->
    <div id="upload-modal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-dialog modal-dialog-sm" role="dialog" aria-modal="true">
        <div class="modal-header">
          <div class="modal-header-left">
            <div class="modal-title">Upload a photo</div>
            <div class="modal-subtitle">We'll use this to generate the character model.</div>
          </div>
          <button id="close-upload-modal" class="icon-btn" title="Close">✕</button>
        </div>

        <div class="modal-body modal-body-col">
          <div id="dropzone" class="dropzone" tabindex="0">
            <div class="dropzone-inner">
              <div class="drop-icon">⬆︎</div>
              <div class="drop-title">Drag & drop your image here</div>
              <div class="drop-sub">or click to choose a file</div>
              <div class="drop-hint">PNG / JPG • up to ~10MB</div>
            </div>
          </div>

          <input id="child-photo" type="file" accept="image/*" class="hidden" />

          <div class="upload-preview-row">
            <div id="upload-preview" class="upload-preview hidden"></div>
            <div class="upload-actions">
              <button id="choose-file-btn" class="btn btn-secondary">Choose file</button>
              <button id="upload-btn" class="btn btn-primary">Upload</button>
            </div>
          </div>

          <div id="upload-status" class="status-line"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- New Story Modal -->
  <div id="new-story-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog auth-modal-dialog" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-header-left">
          <div class="modal-title">Start a New Story</div>
          <div class="modal-subtitle">Tell us about your main character</div>
        </div>
        <button id="close-new-story-modal" class="icon-btn modal-close-btn" title="Close">✕</button>
      </div>

      <div class="modal-body">
        <form id="new-story-form" class="auth-form">
          <div class="form-group">
            <label for="new-story-name">Main Character's Name</label>
            <input id="new-story-name" type="text" placeholder="e.g., Hannah" required />
          </div>

          <div class="form-group">
            <label for="new-story-topic">Story Topic</label>
            <input id="new-story-topic" type="text" placeholder="e.g., space adventure, puppies, soccer" />
          </div>

          <button type="submit" class="btn btn-primary btn-full">
            <span>Generate Story Ideas</span>
          </button>
          
          <div class="modal-tip">
            <strong>Tip:</strong> If you have a specific vision for your story, include as much detail as you can in the topic field.
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Generation History Modal -->
  <div id="history-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog modal-dialog-history" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-header-left">
          <div class="modal-title">Generation History</div>
          <div class="modal-subtitle">All your illustration generations</div>
        </div>
        <button id="close-history-modal" class="icon-btn modal-close-btn" title="Close">✕</button>
      </div>

      <div class="modal-body modal-body-history">
        <div id="history-list" class="history-list">
          <div class="queue-empty">Loading history...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast notifications -->
  <div id="toast-container" class="toast-container"></div>

  <!-- ES Module entry point -->
  <script type="module" src="/js/app.js"></script>

</body>
</html>