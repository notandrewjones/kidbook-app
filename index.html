<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kids Book Creator</title>
  
  <!-- Stripe Publishable Key - Replace with your actual key -->
  <meta name="stripe-publishable-key" content="pk_test_YOUR_PUBLISHABLE_KEY_HERE" />

  <!-- Google Fonts for Kid-Friendly Templates -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=ABeeZee&family=Baloo+2:wght@400;600;700;800&family=Bubblegum+Sans&family=Caveat:wght@400;600;700&family=Chewy&family=Comic+Neue:wght@400;700&family=Fredoka+One&family=Kalam:wght@400;700&family=Luckiest+Guy&family=Nunito:wght@400;600;700;800&family=Patrick+Hand&family=Poppins:wght@400;500;600;700&family=Quicksand:wght@400;500;600;700&family=Schoolbell&family=Sniglet:wght@400;800&family=Varela+Round&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/css/compositor.css" />
  <link rel="stylesheet" href="/css/auth.css" />
</head>

<body>
  <!-- App Shell -->
  <div class="app-shell">

    <!-- Top Nav -->
    <header class="topbar">
      <div class="topbar-left">
        <a href="/dashboard" id="brand-link" class="brand">
          <div class="brand-mark">KB</div>
          <div class="brand-text">
            <div class="brand-name">Business Name</div>
            <div class="brand-sub">Business Tagline</div>
          </div>
        </a>

        <button id="nav-dashboard" class="btn btn-secondary nav-btn">
          <span>Dashboard</span>
        </button>

        <button id="nav-orders" class="btn btn-secondary nav-btn">
          <span>Orders</span>
        </button>
      </div>

      <div class="topbar-right">
        <div class="search-wrap">
          <input id="global-search" class="search-input" placeholder="Search projects..." />
          <span class="kbd-hint">‚åòK</span>
          <div id="search-dropdown" class="search-dropdown hidden"></div>
        </div>

        <!-- Generation Queue/History Button -->
        <div class="queue-wrap">
          <button id="queue-btn" class="icon-btn" title="Generation Queue & History">
            <svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
            <span id="queue-badge" class="queue-badge hidden">0</span>
          </button>
          <div id="queue-dropdown" class="queue-dropdown hidden">
            <div class="queue-header">
              <span class="queue-title">Generation Activity</span>
            </div>
            <div id="queue-list" class="queue-list">
              <div class="queue-empty">No recent generations</div>
            </div>
            <div class="queue-footer">
              <button id="show-all-history" class="btn btn-ghost btn-sm">Show All History</button>
            </div>
          </div>
        </div>

        <!-- Account placeholder -->
        <div class="account">
          <button id="account-btn" class="account-btn">
            <span class="avatar">A</span>
            <span class="account-meta">
              <span class="account-name">Account</span>
              <span class="account-sub">Login / Sign up</span>
            </span>
            <span class="chev">‚ñæ</span>
          </button>

          <div id="account-menu" class="account-menu hidden">
            <button class="menu-item" id="login-btn">Log In</button>
            <button class="menu-item hidden" id="profile-btn">My Profile</button>
            <div class="menu-sep"></div>
            <button class="menu-item hidden" id="logout-btn">Log Out</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main id="main" class="main dashboard-mode">
      <!-- Left Panel / Controls -->
      <aside class="panel" id="sidebar-panel">
        <!-- Create new book panel - only used in non-dashboard views -->
        <div class="panel-card" id="create-book-panel">
          <div class="panel-title">Create a new book</div>

          <form id="kid-form" class="form">
            <label class="label">Main Character's Name</label>
            <input id="kid-name" class="input" type="text" placeholder="e.g., Hannah" required />

            <label class="label">Story Topic</label>
            <input id="kid-interests" class="input" type="text" placeholder="e.g., space, puppies, soccer" />

            <button type="submit" class="btn btn-primary">
              <span>Generate Story Ideas</span>
              <span class="btn-suffix">‚Üµ</span>
            </button>
          </form>

          <div class="panel-actions">
            <button id="reset-session" class="btn btn-ghost">Start New Story</button>
            <button id="go-dashboard" class="btn btn-secondary">My Stories</button>
          </div>
        </div>

        <div class="panel-card subtle" id="tips-panel">
          <div class="panel-title">Tips</div>
          <ul class="tips">
            <li>If you have a specific vision for your story, include as much detail as your can in your 'topic' submission.</li>
          </ul>
        </div>
      </aside>

      <!-- Workspace -->
      <section class="workspace">
        <div class="workspace-head">
          <div class="workspace-title">
            <h2 id="workspace-title">Workspace</h2>
            <p id="workspace-subtitle">Pick a project or generate story ideas to begin.</p>
          </div>

          <!-- View / Filter Controls -->
          <div class="workspace-controls">
            <div class="segmented">
              <button class="seg-btn active" data-view="grid" id="view-grid">Grid</button>
              <button class="seg-btn" data-view="list" id="view-list">List</button>
            </div>

            <select id="page-filter" class="select">
              <option value="all">All pages</option>
              <option value="missing">Missing</option>
              <option value="ready">Ready</option>
              <option value="errors">Errors</option>
            </select>
          </div>
        </div>

        <!-- Workspace body: phase-controlled layout -->
        <div class="workspace-body">

          <!-- Storyboard-only: character panel column -->
          <aside id="character-panel" class="character-panel" aria-label="Character panel">
            <div id="character-panel-content"></div>
          </aside>

          <!-- Main results mount (used in all phases) -->
          <div id="results" class="results"></div>

        </div>
        
      </section>
    </main>

    <!-- Illustration Preview + Regenerate Modal -->
    <div id="image-modal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-dialog modal-dialog-preview" role="dialog" aria-modal="true">
        <div class="modal-header">
          <div class="modal-header-left">
            <div class="modal-title">Illustration Preview</div>
            <div id="modal-subtitle" class="modal-subtitle">Page</div>
          </div>
          <button id="close-modal" class="icon-btn modal-close-btn" title="Close">‚úï</button>
        </div>

        <div class="modal-body modal-body-preview">
          <!-- Left side: Main image preview -->
          <div class="preview-main">
            <div class="modal-image-wrap">
              <img id="modal-image" src="" alt="Illustration preview" />
            </div>
          </div>

          <!-- Right side: Controls and history -->
          <div class="preview-controls">
            <!-- Current version indicator -->
            <div class="preview-section">
              <div class="preview-section-label">Current Version</div>
              <div id="current-version-indicator" class="hidden"></div>
            </div>
            
            <!-- Revision history -->
            <div id="revision-history" class="preview-section hidden">
              <div class="preview-section-label">Previous Versions</div>
              <div class="revision-thumbs-container"></div>
            </div>
            
            <!-- Use this version button (shown when viewing a past revision) -->
            <button id="use-version-btn" class="btn btn-secondary btn-full hidden">
              <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
              </svg>
              <span>Use This Version</span>
            </button>
            
            <!-- Regeneration controls -->
            <div class="preview-section preview-regen-section">
              <div class="preview-section-label">Regenerate with Notes</div>
              <div id="regen-available" class="regen-controls">
                <div class="form-group">
                  <textarea id="revision-notes" class="textarea textarea-sm" placeholder="e.g., remove balloons, make it sunset, add more cowbell..."></textarea>
                </div>
                <button id="regen-btn" class="btn btn-primary btn-full">
                  <span>Regenerate</span>
                  <span id="regen-remaining" class="pill">2 left</span>
                </button>
              </div>
              
              <!-- Shown when regen limit reached -->
              <div id="regen-limit-reached" class="regen-limit-msg hidden">
                <div class="limit-notice">
                  <span class="limit-icon">‚ö†Ô∏è</span>
                  <span>Regeneration limit reached for this image.</span>
                </div>
                <button id="request-human-btn" class="btn btn-secondary btn-full">
                  <span>üé® Request Human Review</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Human Review Request Modal -->
    <div id="human-request-modal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-dialog auth-modal-dialog" role="dialog" aria-modal="true">
        <div class="modal-header">
          <div class="modal-header-left">
            <div class="modal-title">Request Human Review</div>
            <div class="modal-subtitle">Our artists will manually fix your illustration</div>
          </div>
          <button id="close-human-request-modal" class="icon-btn modal-close-btn" title="Close">‚úï</button>
        </div>

        <div class="modal-body">
          <form id="human-request-form" class="auth-form">
            <div class="human-request-info">
              <p>You've reached the regeneration limit for this image. Submit a request and our team will manually review and fix your illustration.</p>
            </div>
            
            <div class="form-group">
              <label for="human-request-page">Page Number</label>
              <input id="human-request-page" type="text" readonly />
            </div>

            <div class="form-group">
              <label for="human-request-notes">What would you like changed?</label>
              <textarea id="human-request-notes" class="textarea" placeholder="Please describe what you'd like our artists to fix or change about this illustration..." required></textarea>
            </div>

            <button type="submit" class="btn btn-primary btn-full">
              <span>Submit Request</span>
            </button>
            
            <div class="modal-tip">
              <strong>Note:</strong> Human reviews typically take 1-2 business days. You'll receive an email when your updated illustration is ready.
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Custom Upload Modal -->
    <div id="upload-modal" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-dialog modal-dialog-sm" role="dialog" aria-modal="true">
        <div class="modal-header">
          <div class="modal-header-left">
            <div class="modal-title">Upload a photo</div>
            <div class="modal-subtitle">We'll use this to generate the character model.</div>
          </div>
          <button id="close-upload-modal" class="icon-btn" title="Close">‚úï</button>
        </div>

        <div class="modal-body modal-body-col">
          <div id="dropzone" class="dropzone" tabindex="0">
            <div class="dropzone-inner">
              <div class="drop-icon">‚¨ÜÔ∏é</div>
              <div class="drop-title">Drag & drop your image here</div>
              <div class="drop-sub">or click to choose a file</div>
              <div class="drop-hint">PNG / JPG ‚Ä¢ up to ~10MB</div>
            </div>
          </div>

          <input id="child-photo" type="file" accept="image/*" class="hidden" />

          <div class="upload-preview-row">
            <div id="upload-preview" class="upload-preview hidden"></div>
            <div class="upload-actions">
              <button id="choose-file-btn" class="btn btn-secondary">Choose file</button>
              <button id="upload-btn" class="btn btn-primary">Upload</button>
            </div>
          </div>

          <div id="upload-status" class="status-line"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- New Story Modal -->
  <div id="new-story-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog auth-modal-dialog" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-header-left">
          <div class="modal-title">Start a New Story</div>
          <div class="modal-subtitle">Tell us about your main character</div>
        </div>
        <button id="close-new-story-modal" class="icon-btn modal-close-btn" title="Close">‚úï</button>
      </div>

      <div class="modal-body">
        <form id="new-story-form" class="auth-form">
          <div class="form-group">
            <label for="new-story-name">Main Character's Name</label>
            <input id="new-story-name" type="text" placeholder="e.g., Hannah" required />
          </div>

          <div class="form-group">
            <label for="new-story-topic">Story Topic</label>
            <input id="new-story-topic" type="text" placeholder="e.g., space adventure, puppies, soccer" />
          </div>

          <button type="submit" class="btn btn-primary btn-full">
            <span>Generate Story Ideas</span>
          </button>
          
          <div class="modal-tip">
            <strong>Tip:</strong> If you have a specific vision for your story, include as much detail as you can in the topic field.
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Generation History Modal -->
  <div id="history-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog modal-dialog-history" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div class="modal-header-left">
          <div class="modal-title">Generation History</div>
          <div class="modal-subtitle">All your illustration generations</div>
        </div>
        <button id="close-history-modal" class="icon-btn modal-close-btn" title="Close">‚úï</button>
      </div>

      <div class="modal-body modal-body-history">
        <div id="history-list" class="history-list">
          <div class="queue-empty">Loading history...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Confirmation Modal -->
  <div id="order-confirmation-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-backdrop"></div>
    <div class="modal-dialog order-modal-dialog" role="dialog" aria-modal="true">
      <div class="order-modal-content">
        <!-- Animated Success Icon -->
        <div id="order-success-icon" class="order-success-icon">
          <div class="order-truck-wrapper">
            <div class="order-truck-body">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 198 93" class="order-truck-svg">
                <path stroke-width="3" stroke="#282828" fill="#8b5cf6" d="M135 22.5H177.264C178.295 22.5 179.22 23.133 179.594 24.0939L192.33 56.8443C192.442 57.1332 192.5 57.4404 192.5 57.7504V89C192.5 90.3807 191.381 91.5 190 91.5H135C133.619 91.5 132.5 90.3807 132.5 89V25C132.5 23.6193 133.619 22.5 135 22.5Z"></path>
                <path stroke-width="3" stroke="#282828" fill="#7D7C7C" d="M146 33.5H181.741C182.779 33.5 183.709 34.1415 184.078 35.112L190.538 52.112C191.16 53.748 189.951 55.5 188.201 55.5H146C144.619 55.5 143.5 54.3807 143.5 53V36C143.5 34.6193 144.619 33.5 146 33.5Z"></path>
                <path stroke-width="2" stroke="#282828" fill="#282828" d="M150 65C150 65.39 149.763 65.8656 149.127 66.2893C148.499 66.7083 147.573 67 146.5 67C145.427 67 144.501 66.7083 143.873 66.2893C143.237 65.8656 143 65.39 143 65C143 64.61 143.237 64.1344 143.873 63.7107C144.501 63.2917 145.427 63 146.5 63C147.573 63 148.499 63.2917 149.127 63.7107C149.763 64.1344 150 64.61 150 65Z"></path>
                <rect stroke-width="2" stroke="#282828" fill="#FFFCAB" rx="1" height="7" width="5" y="63" x="187"></rect>
                <rect stroke-width="2" stroke="#282828" fill="#282828" rx="1" height="11" width="4" y="81" x="193"></rect>
                <rect stroke-width="3" stroke="#282828" fill="#DFDFDF" rx="2.5" height="90" width="121" y="1.5" x="6.5"></rect>
                <rect stroke-width="2" stroke="#282828" fill="#DFDFDF" rx="2" height="4" width="6" y="84" x="1"></rect>
              </svg>
            </div>
            <div class="order-truck-tires">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 30 30">
                <circle stroke-width="3" stroke="#282828" fill="#282828" r="13.5" cy="15" cx="15"></circle>
                <circle fill="#DFDFDF" r="7" cy="15" cx="15"></circle>
              </svg>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 30 30">
                <circle stroke-width="3" stroke="#282828" fill="#282828" r="13.5" cy="15" cx="15"></circle>
                <circle fill="#DFDFDF" r="7" cy="15" cx="15"></circle>
              </svg>
            </div>
            <div class="order-road"></div>
            <svg class="order-lamp-post" viewBox="0 0 453.459 453.459" xmlns="http://www.w3.org/2000/svg">
              <path d="M252.882,0c-37.781,0-68.686,29.953-70.245,67.358h-6.917v8.954c-26.109,2.163-45.463,10.011-45.463,19.366h9.993c-1.65,5.146-2.507,10.54-2.507,16.017c0,28.956,23.558,52.514,52.514,52.514c28.956,0,52.514-23.558,52.514-52.514c0-5.478-0.856-10.872-2.506-16.017h9.992c0-9.354-19.352-17.204-45.463-19.366v-8.954h-6.149C200.189,38.779,223.924,16,252.882,16c29.952,0,54.32,24.368,54.32,54.32c0,28.774-11.078,37.009-25.105,47.437c-17.444,12.968-37.216,27.667-37.216,78.884v113.914h-0.797c-5.068,0-9.174,4.108-9.174,9.177c0,2.844,1.293,5.383,3.321,7.066c-3.432,27.933-26.851,95.744-8.226,115.459v11.202h45.75v-11.202c18.625-19.715-4.794-87.527-8.227-115.459c2.029-1.683,3.322-4.223,3.322-7.066c0-5.068-4.107-9.177-9.176-9.177h-0.795V196.641c0-43.174,14.942-54.283,30.762-66.043c14.793-10.997,31.559-23.461,31.559-60.277C323.202,31.545,291.656,0,252.882,0zM232.77,111.694c0,23.442-19.071,42.514-42.514,42.514c-23.442,0-42.514-19.072-42.514-42.514c0-5.531,1.078-10.957,3.141-16.017h78.747C231.693,100.736,232.77,106.162,232.77,111.694z"></path>
            </svg>
          </div>
          <div id="order-success-checkmark" class="order-success-checkmark">
            <svg class="order-checkmark-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
              <circle class="order-checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
              <path class="order-checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
            </svg>
          </div>
        </div>

        <h2 class="order-modal-title">Order Confirmed!</h2>
        <p class="order-modal-subtitle">Thank you for your purchase</p>
        
        <div class="order-details">
          <div class="order-detail-row">
            <span class="order-detail-label">Order Number</span>
            <span id="order-number" class="order-detail-value">#---</span>
          </div>
          <div class="order-detail-row">
            <span class="order-detail-label">Status</span>
            <span class="order-detail-value order-status-badge">Processing</span>
          </div>
        </div>

        <p class="order-modal-info">
          You'll receive an email confirmation shortly with your order details and tracking information.
        </p>

        <button id="close-order-modal" class="btn btn-primary btn-full">
          Continue to Dashboard
        </button>
      </div>
    </div>
  </div>

  <!-- Toast notifications -->
  <div id="toast-container" class="toast-container"></div>

  <!-- ES Module entry point -->
  <script type="module" src="/js/app.js"></script>

</body>
</html>